name: Build WordPress theme package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (e.g. v0.5.0-beta)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="${{ inputs.tag }}"
          fi

          if [[ -z "$TAG" ]]; then
            echo "Tag is required." >&2
            exit 1
          fi

          VERSION="${TAG#v}"
          THEME_SLUG="a-ripple-song"
          ARCHIVE_NAME="${THEME_SLUG}-${VERSION}.zip"

          PRERELEASE=false
          if [[ "$VERSION" == *"-"* ]]; then
            PRERELEASE=true
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "theme_slug=$THEME_SLUG" >> "$GITHUB_OUTPUT"
          echo "archive_name=$ARCHIVE_NAME" >> "$GITHUB_OUTPUT"
          echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"

      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.vars.outputs.tag }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:v2
          extensions: mbstring, dom, curl, zip

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Composer dependencies (production)
        run: composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-progress

      - name: Install Node dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Create release package
        shell: bash
        run: |
          set -euo pipefail

          THEME_SLUG="${{ steps.vars.outputs.theme_slug }}"
          ARCHIVE_NAME="${{ steps.vars.outputs.archive_name }}"

          rm -rf dist
          mkdir -p "dist/${THEME_SLUG}"

          # Build a minimal, installable WordPress theme package.
          # Includes: PHP/theme files, Blade views, translations, built assets and vendor dependencies.
          rsync -a --prune-empty-dirs \
            --include="app/***" \
            --include="data/***" \
            --include="public/***" \
            --exclude="public/hot" \
            --include="resources/" \
            --include="resources/views/***" \
            --include="resources/lang/***" \
            --include="resources/images/***" \
            --include="resources/fonts/***" \
            --include="vendor/***" \
            --include="composer.json" \
            --include="composer.lock" \
            --include="readme.txt" \
            --include="LICENSE" \
            --include="functions.php" \
            --include="index.php" \
            --include="searchform.php" \
            --include="editor-style.css" \
            --include="style.css" \
            --include="screenshot.png" \
            --include="theme.json" \
            --include="docs/***" \
            --exclude="*" \
            ./ "dist/${THEME_SLUG}/"

          find "dist/${THEME_SLUG}" -name ".DS_Store" -delete

          (cd dist && zip -r "../${ARCHIVE_NAME}" "${THEME_SLUG}" -x "**/.DS_Store")

      - name: Ensure GitHub Release
        id: release
        uses: actions/github-script@v7
        env:
          TAG: ${{ steps.vars.outputs.tag }}
          PRERELEASE: ${{ steps.vars.outputs.prerelease }}
        with:
          script: |
            const tag = process.env.TAG;
            const prerelease = process.env.PRERELEASE === 'true';

            let release;
            try {
              const res = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag,
              });
              release = res.data;
              core.info(`Found existing release for ${tag} (id: ${release.id}).`);
            } catch (error) {
              if (error.status !== 404) throw error;
              core.info(`No release found for ${tag}. Creating one...`);
              const created = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: tag,
                draft: false,
                prerelease,
                generate_release_notes: true,
              });
              release = created.data;
              core.info(`Created release for ${tag} (id: ${release.id}).`);
            }

            core.setOutput('id', release.id.toString());

      - name: Delete existing asset (if any)
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ steps.release.outputs.id }}
          ASSET_NAME: ${{ steps.vars.outputs.archive_name }}
        with:
          script: |
            const releaseId = Number(process.env.RELEASE_ID);
            const assetName = process.env.ASSET_NAME;

            const assetsRes = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
            });

            const existing = (assetsRes.data || []).find(a => a.name === assetName);
            if (!existing) {
              core.info(`No existing asset named "${assetName}" on release ${releaseId}.`);
              return;
            }

            core.info(`Deleting existing asset "${assetName}" (id: ${existing.id}) on release ${releaseId}...`);
            await github.rest.repos.deleteReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              asset_id: existing.id,
            });

      - name: Upload package to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          files: ${{ steps.vars.outputs.archive_name }}
