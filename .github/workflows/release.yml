name: Build WordPress theme package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (e.g. v0.5.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="${{ inputs.tag }}"
          fi

          if [[ -z "$TAG" ]]; then
            echo "Tag is required." >&2
            exit 1
          fi

          VERSION="${TAG#v}"
          THEME_SLUG="a-ripple-song"
          ARCHIVE_NAME="${THEME_SLUG}-${VERSION}.zip"

          PRERELEASE=false
          if [[ "$VERSION" == *"-"* ]]; then
            PRERELEASE=true
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "theme_slug=$THEME_SLUG" >> "$GITHUB_OUTPUT"
          echo "archive_name=$ARCHIVE_NAME" >> "$GITHUB_OUTPUT"
          echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"

      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.vars.outputs.tag }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:v2
          extensions: mbstring, dom, curl, zip

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Composer dependencies (production)
        run: composer install --prefer-dist --optimize-autoloader --no-interaction --no-progress

      - name: Install Node dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Build release package (scoped vendor)
        shell: bash
        run: |
          set -euo pipefail

          chmod +x bin/build-release
          bin/build-release "${{ steps.vars.outputs.theme_slug }}" "${{ steps.vars.outputs.archive_name }}"

      - name: Ensure GitHub Release
        id: release
        uses: actions/github-script@v7
        env:
          TAG: ${{ steps.vars.outputs.tag }}
          PRERELEASE: ${{ steps.vars.outputs.prerelease }}
        with:
          script: |
            const tag = process.env.TAG;
            const prerelease = process.env.PRERELEASE === 'true';

            let release;
            try {
              const res = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag,
              });
              release = res.data;
              core.info(`Found existing release for ${tag} (id: ${release.id}).`);
            } catch (error) {
              if (error.status !== 404) throw error;
              core.info(`No release found for ${tag}. Creating one...`);
              const created = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: tag,
                draft: false,
                prerelease,
                generate_release_notes: true,
              });
              release = created.data;
              core.info(`Created release for ${tag} (id: ${release.id}).`);
            }

            core.setOutput('id', release.id.toString());

      - name: Delete existing asset (if any)
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ steps.release.outputs.id }}
          ASSET_NAME: ${{ steps.vars.outputs.archive_name }}
        with:
          script: |
            const releaseId = Number(process.env.RELEASE_ID);
            const assetName = process.env.ASSET_NAME;

            const assetsRes = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
            });

            const existing = (assetsRes.data || []).find(a => a.name === assetName);
            if (!existing) {
              core.info(`No existing asset named "${assetName}" on release ${releaseId}.`);
              return;
            }

            core.info(`Deleting existing asset "${assetName}" (id: ${existing.id}) on release ${releaseId}...`);
            await github.rest.repos.deleteReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              asset_id: existing.id,
            });

      - name: Upload package to GitHub Release
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ steps.release.outputs.id }}
          ASSET_NAME: ${{ steps.vars.outputs.archive_name }}
          ASSET_PATH: ${{ steps.vars.outputs.archive_name }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const releaseId = Number(process.env.RELEASE_ID);
            const assetName = process.env.ASSET_NAME;
            const assetPath = process.env.ASSET_PATH;

            const workspace = process.env.GITHUB_WORKSPACE || process.cwd();
            const fullPath = path.isAbsolute(assetPath) ? assetPath : path.join(workspace, assetPath);

            if (!fs.existsSync(fullPath)) {
              throw new Error(`Release asset not found: ${fullPath}`);
            }

            const data = fs.readFileSync(fullPath);

            const maxRetries = 5;
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
              try {
                core.info(`Uploading "${assetName}" (attempt ${attempt}/${maxRetries})...`);
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: assetName,
                  data,
                  headers: {
                    'content-type': 'application/zip',
                    'content-length': data.length,
                  },
                });
                core.info(`Uploaded "${assetName}" to release ${releaseId}.`);
                return;
              } catch (error) {
                core.warning(`Upload failed (attempt ${attempt}/${maxRetries}): ${error.message || error}`);
                if (attempt === maxRetries) throw error;
                await new Promise(resolve => setTimeout(resolve, attempt * 5000));
              }
            }
