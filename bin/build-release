#!/usr/bin/env bash

set -euo pipefail

THEME_SLUG="${1:-a-ripple-song}"
ARCHIVE_NAME="${2:-${THEME_SLUG}.zip}"

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BUILD_ROOT="$(mktemp -d -t "${THEME_SLUG}" 2>/dev/null || mktemp -d -t "${THEME_SLUG}.XXXXXX")"
WORKDIR="${BUILD_ROOT}/workdir"
SCOPED_DIR="${WORKDIR}/build/scoped"
DIST_DIR="${BUILD_ROOT}/dist/${THEME_SLUG}"

cleanup() {
  rm -rf "${BUILD_ROOT}"
}
trap cleanup EXIT

if [[ ! -d "${ROOT_DIR}/public/build" ]]; then
  echo "Missing public/build. Run \`npm run build\` first." >&2
  exit 1
fi

if [[ ! -f "${ROOT_DIR}/vendor/bin/php-scoper" ]]; then
  echo "Missing php-scoper. Run \`composer install\` (with dev dependencies) first." >&2
  exit 1
fi

rm -rf "${WORKDIR}"
mkdir -p "${WORKDIR}"

rsync -a --prune-empty-dirs \
  --include="app/***" \
  --include="functions.php" \
  --include="index.php" \
  --include="searchform.php" \
  --include="composer.json" \
  --include="composer.lock" \
  --include="scoper.inc.php" \
  --exclude="*" \
  "${ROOT_DIR}/" "${WORKDIR}/"

(
  cd "${WORKDIR}"
  composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-progress --no-scripts
)

php "${ROOT_DIR}/bin/patch-carbon-fields-hooks.php" "${WORKDIR}/vendor/htmlburger/carbon-fields"

(
  cd "${WORKDIR}"
  # PHP 8.5+ triggers new deprecations in PHP-Scoper's internals; silence deprecations so builds remain deterministic.
  php -d error_reporting=8191 "${ROOT_DIR}/vendor/bin/php-scoper" add-prefix --config scoper.inc.php
)

mkdir -p "${DIST_DIR}"

rsync -a --prune-empty-dirs \
  --include="data/***" \
  --include="public/***" \
  --exclude="public/hot" \
  --include="resources/" \
  --include="resources/views/***" \
  --include="resources/lang/***" \
  --include="resources/images/***" \
  --include="resources/fonts/***" \
  --include="composer.json" \
  --include="composer.lock" \
  --include="readme.txt" \
  --include="LICENSE" \
  --include="editor-style.css" \
  --include="style.css" \
  --include="screenshot.png" \
  --include="theme.json" \
  --include="docs/***" \
  --exclude="app/***" \
  --exclude="vendor/***" \
  --exclude="functions.php" \
  --exclude="index.php" \
  --exclude="searchform.php" \
  --exclude="*" \
  "${ROOT_DIR}/" "${DIST_DIR}/"

rsync -a "${SCOPED_DIR}/app/" "${DIST_DIR}/app/"
cp "${SCOPED_DIR}/functions.php" "${DIST_DIR}/functions.php"
cp "${SCOPED_DIR}/index.php" "${DIST_DIR}/index.php"
cp "${SCOPED_DIR}/searchform.php" "${DIST_DIR}/searchform.php"
rsync -a "${SCOPED_DIR}/vendor/" "${DIST_DIR}/vendor/"

cp "${ROOT_DIR}/bin/scoper-autoload.php" "${DIST_DIR}/vendor/scoper-autoload.php"

# Prune files not needed at runtime to keep the release archive small.
# - getID3 ships optional helper binaries (Windows/Cygwin) that are not used by the theme.
rm -rf "${DIST_DIR}/vendor/james-heinrich/getid3/helperapps" || true
# - Keep Composer metadata needed by Acorn package discovery.
# - Carbon Fields ships front-end tooling files (Node/Webpack) that are not used by the theme at runtime.
rm -rf "${DIST_DIR}/vendor/htmlburger/carbon-fields/bin" || true
rm -rf "${DIST_DIR}/vendor/htmlburger/carbon-fields/.phpstorm.meta.php" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/package.json" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/yarn.lock" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/webpack.config.js" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.babelrc.js" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.browserlistrc" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.editorconfig" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.eslintrc.js" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.huskyrc.js" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.lintstagedrc.js" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.nvmrc" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/.postcssrc.js" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/CONTRIBUTING.md" || true
rm -f "${DIST_DIR}/vendor/htmlburger/carbon-fields/ISSUE_TEMPLATE.md" || true
# - Carbon Fields translations are optional (WordPress language packs cover the theme itself).
rm -rf "${DIST_DIR}/vendor/htmlburger/carbon-fields/languages" || true
# - Keep only minified Carbon Fields assets to reduce package size.
find "${DIST_DIR}/vendor/htmlburger/carbon-fields/build" -type f \( -name "*.js" -o -name "*.css" \) ! -name "*.min.js" ! -name "*.min.css" -delete || true
# - Ensure Carbon Fields always loads minified assets (we remove the unminified ones above).
CARBON_LOADER_PATH="${DIST_DIR}/vendor/htmlburger/carbon-fields/core/Loader/Loader.php"
if [[ -f "${CARBON_LOADER_PATH}" ]]; then
  php -r '
    $path = $argv[1] ?? null;
    if (!is_string($path) || $path === "" || !is_file($path)) { exit(0); }
    $contents = file_get_contents($path);
    if ($contents === false) { exit(0); }
    $needle = "return defined( \\'SCRIPT_DEBUG\\' ) && SCRIPT_DEBUG ? \\'\\' : \\'\\.min\\';";
    $replacement = "return \\'\\.min\\';";
    $patched = str_replace($needle, $replacement, $contents);
    if ($patched !== $contents) {
      file_put_contents($path, $patched);
    }
  ' "${CARBON_LOADER_PATH}" || true
fi
# - Remove source translation files from the release (runtime uses .mo/.json).
find "${DIST_DIR}/resources/lang" -maxdepth 1 -type f \( -name "*.po" -o -name "*.pot" \) -delete || true
# - Remove dev docs from getID3.
rm -f "${DIST_DIR}/vendor/james-heinrich/getid3/README.md" || true
rm -f "${DIST_DIR}/vendor/james-heinrich/getid3/changelog.txt" || true
rm -f "${DIST_DIR}/vendor/james-heinrich/getid3/dependencies.txt" || true
rm -f "${DIST_DIR}/vendor/james-heinrich/getid3/readme.txt" || true
rm -f "${DIST_DIR}/vendor/james-heinrich/getid3/structure.txt" || true
# - Remove theme build metadata and docs (not required to run the theme).
rm -rf "${DIST_DIR}/docs" || true
rm -rf "${DIST_DIR}/data" || true
rm -f "${DIST_DIR}/composer.lock" || true
# - Remove vendor documentation/metadata and CI tooling.
find "${DIST_DIR}/vendor" -type d \( -name ".github" -o -name ".circleci" -o -name ".gitlab" -o -name "CI" -o -name "docs" -o -name "doc" -o -name "tests" -o -name "test" \) -prune -exec rm -rf {} + 2>/dev/null || true
find "${DIST_DIR}/vendor" -type f \( -name "*.md" -o -name "composer.json" -o -name "package.json" -o -name "package-lock.json" -o -name "pnpm-lock.yaml" -o -name "yarn.lock" -o -name "npm-shrinkwrap.json" -o -name ".editorconfig" -o -name ".gitattributes" -o -name ".gitignore" -o -name ".travis.yml" \) -delete 2>/dev/null || true

find "${DIST_DIR}" -name ".DS_Store" -delete

rm -f "${ROOT_DIR}/${ARCHIVE_NAME}"
(cd "${BUILD_ROOT}/dist" && zip -r -9 "${ROOT_DIR}/${ARCHIVE_NAME}" "${THEME_SLUG}" -x "**/.DS_Store")

echo "Built ${ARCHIVE_NAME}"
